# üéØ PLAN D'IMPL√âMENTATION - SYST√àME ZUSTAND POUR BOOKING SUCCESS

## üìã OBJECTIF

R√©soudre le probl√®me de redirection vers la page success sur les domaines personnalis√©s en utilisant Zustand pour stocker temporairement les donn√©es de r√©servation, √©vitant ainsi les probl√®mes de middleware avec les param√®tres d'URL.

---

## üèóÔ∏è ARCHITECTURE PROPOS√âE

### **1. Store Zustand pour Booking Confirmation**

```typescript
// src/lib/stores/booking-confirmation-store.ts
import { create } from "zustand";
import { devtools } from "zustand/middleware";

interface BookingData {
  id: string;
  establishment_id: string;
  date: string;
  time: string;
  service_name: string;
  customer_first_name: string;
  customer_last_name: string;
  customer_email: string;
  customer_phone: string;
  number_of_guests: number;
  special_requests?: string;
  status: string;
  created_at: string;
  establishment: {
    id: string;
    name: string;
    slug: string;
    address: string;
    phone: string;
    email: string;
    description: string;
    image_url: string;
  };
}

interface BookingConfirmationState {
  confirmationData: BookingData | null;
  timestamp: number | null;
  setConfirmationData: (data: BookingData) => void;
  clearConfirmationData: () => void;
  isExpired: () => boolean;
  getConfirmationData: () => BookingData | null;
}

export const useBookingConfirmationStore = create<BookingConfirmationState>()(
  devtools(
    (set, get) => ({
      confirmationData: null,
      timestamp: null,

      setConfirmationData: (data: BookingData) =>
        set({
          confirmationData: data,
          timestamp: Date.now(),
        }),

      clearConfirmationData: () =>
        set({
          confirmationData: null,
          timestamp: null,
        }),

      isExpired: () => {
        const { timestamp } = get();
        return timestamp ? Date.now() - timestamp > 5 * 60 * 1000 : true; // 5 minutes
      },

      getConfirmationData: () => {
        const { confirmationData, timestamp } = get();
        if (!confirmationData || !timestamp) return null;

        // V√©rifier l'expiration
        if (Date.now() - timestamp > 5 * 60 * 1000) {
          get().clearConfirmationData();
          return null;
        }

        return confirmationData;
      },
    }),
    {
      name: "booking-confirmation-store",
    },
  ),
);
```

### **2. Flux de Donn√©es**

```
1. Cr√©ation de r√©servation ‚Üí API retourne donn√©es compl√®tes
2. Stockage dans Zustand ‚Üí Donn√©es temporaires (5 min)
3. Redirection sans param√®tres ‚Üí √âvite probl√®mes middleware
4. Lecture depuis Zustand ‚Üí Affichage de confirmation
5. Nettoyage automatique ‚Üí Apr√®s utilisation
```

---

## üîß IMPL√âMENTATION TECHNIQUE

### **√âtape 1 : Cr√©er le Store Zustand**

**Fichier :** `src/lib/stores/booking-confirmation-store.ts`

**Action :** Cr√©er le fichier avec le code Zustand ci-dessus

**Avantages :**

- ‚úÖ Persistance au refresh (devtools middleware)
- ‚úÖ Expiration automatique (5 minutes)
- ‚úÖ Type safety (TypeScript)
- ‚úÖ Pattern familier (coh√©rence projet)

### **√âtape 2 : Modifier l'API Route**

**Fichier :** `src/app/api/booking/create/route.ts`

**Modifications :**

```typescript
// Ligne ~150 : Modifier le return
return NextResponse.json(
  {
    success: true,
    message: "R√©servation cr√©√©e avec succ√®s",
    bookingId: booking.id,
    bookingData: {
      id: booking.id,
      establishment_id: booking.establishment_id,
      date: booking.date,
      time: booking.time,
      service_name: booking.service_name,
      customer_first_name: booking.customer_first_name,
      customer_last_name: booking.customer_last_name,
      customer_email: booking.customer_email,
      customer_phone: booking.customer_phone,
      number_of_guests: booking.number_of_guests,
      special_requests: booking.special_requests,
      status: booking.status,
      created_at: booking.created_at,
      establishment: {
        id: establishment.id,
        name: establishment.name,
        slug: establishment.slug,
        address: establishment.address,
        phone: establishment.phone,
        email: establishment.email,
        description: establishment.description,
        image_url: establishment.image_url,
      },
    },
  },
  { status: 201 },
);
```

### **√âtape 3 : Modifier la Fonction createBooking**

**Fichier :** `src/app/[locale]/(root)/(public)/[slug]/booking/_components/database-utils.ts`

**Modifications :**

```typescript
// Ligne ~140 : Modifier l'interface de retour
): Promise<{
  success: boolean;
  bookingId?: string;
  bookingData?: any; // Ajouter cette ligne
  error?: string
}> {

// Ligne ~180 : Modifier le return
return {
  success: true,
  bookingId: data.booking.id,
  bookingData: data.bookingData, // Ajouter cette ligne
};
```

### **√âtape 4 : Modifier la Page de Confirmation**

**Fichier :** `src/app/[locale]/(root)/(public)/[slug]/booking/confirm/[date]/[time]/page.tsx`

**Modifications :**

```typescript
// Ligne ~10 : Ajouter l'import Zustand
import { useBookingConfirmationStore } from "@/lib/stores/booking-confirmation-store";

// Ligne ~150 : Modifier handleSubmit
if (result.success && result.bookingData) {
  // Stocker dans Zustand
  useBookingConfirmationStore.getState().setConfirmationData(result.bookingData);

  // D√©tecter le type de domaine pour √©viter les probl√®mes de middleware
  const isCustomDomain = window.location.hostname !== "logones.fr";

  if (isCustomDomain) {
    // Domaine personnalis√© : URL sans slug (le middleware ajoute le slug)
    router.push(`/fr/booking/success`);
  } else {
    // Domaine principal : URL avec slug
    router.push(`/fr/${establishment.slug}/booking/success`);
  }
} else {
  setError(result.error ?? t("error.generic"));
}
```

### **√âtape 5 : Modifier la Page Success**

**Fichier :** `src/app/[locale]/(root)/(public)/[slug]/booking/success/page.tsx`

**Modifications :**

```typescript
// Ligne ~10 : Ajouter l'import Zustand
import { useBookingConfirmationStore } from "@/lib/stores/booking-confirmation-store";

// Ligne ~60 : Remplacer loadData
async function loadData() {
  try {
    const resolvedParams = await params;
    const establishmentSlug =
      resolvedParams.slug ?? resolvedParams["establishment-slug"] ?? resolvedParams.establishmentSlug;

    if (!establishmentSlug) {
      console.error("‚ùå Slug manquant");
      return;
    }

    // R√©cup√©rer depuis Zustand
    const bookingData = useBookingConfirmationStore.getState().getConfirmationData();

    if (!bookingData) {
      console.log("‚ùå Pas de donn√©es de confirmation, redirection");
      router.push(`/${establishmentSlug}/booking`);
      return;
    }

    // R√©cup√©rer l'√©tablissement
    const establishmentData = await getEstablishmentBySlug(establishmentSlug);

    setEstablishment(establishmentData);
    setBooking(bookingData);

    // Nettoyer le store apr√®s utilisation
    useBookingConfirmationStore.getState().clearConfirmationData();
  } catch (error) {
    console.error("‚ùå Erreur lors du chargement:", error);
  } finally {
    setLoading(false);
  }
}
```

### **√âtape 6 : Supprimer les √âl√©ments Obsol√®tes**

**Actions :**

1. **Supprimer la fonction getBookingWithToken** de `database-utils.ts`
2. **Supprimer les scripts RLS obsol√®tes** :
   - `scripts/bookings-secure-update.sql`
   - `scripts/bookings-insert-policy-fix.sql`
   - `scripts/bookings-anon-insert-fix.sql`
   - `scripts/bookings-public-insert.sql`

### **√âtape 7 : Supprimer la Policy SELECT Publique**

**Fichier :** `scripts/remove-bookings-select-public.sql`

**Contenu :**

```sql
-- Supprimer la policy SELECT publique (plus n√©cessaire avec Zustand)
DROP POLICY IF EXISTS "bookings_select_public" ON bookings;

-- V√©rifier le r√©sultat
SELECT
    policyname,
    permissive,
    roles,
    cmd
FROM pg_policies
WHERE tablename = 'bookings'
ORDER BY policyname;
```

---

## üìö DOCUMENTATION

### **√âtape 8 : Cr√©er la Documentation Zustand Pattern**

**Fichier :** `Documentation/GUIDES-TECHNIQUES/ZUSTAND-PATTERN.md`

**Contenu :**

````markdown
# üóÇÔ∏è Pattern Zustand pour Donn√©es Temporaires

## üéØ Objectif

G√©rer les donn√©es temporaires entre pages sans utiliser les param√®tres d'URL, particuli√®rement utile pour les domaines personnalis√©s avec middleware.

## üìã Cas d'Usage

- ‚úÖ **Pages de confirmation** (booking success)
- ‚úÖ **Donn√©es sensibles** (tokens, informations personnelles)
- ‚úÖ **Navigation complexe** (domaines personnalis√©s)
- ‚úÖ **Performance** (√©viter les requ√™tes base)

## üîß Impl√©mentation

### **1. Cr√©ation du Store**

```typescript
import { create } from "zustand";
import { devtools } from "zustand/middleware";

interface State {
  data: any;
  timestamp: number | null;
  setData: (data: any) => void;
  clearData: () => void;
  isExpired: () => boolean;
  getData: () => any;
}

export const useStore = create<State>()(
  devtools(
    (set, get) => ({
      data: null,
      timestamp: null,

      setData: (data: any) =>
        set({
          data,
          timestamp: Date.now(),
        }),

      clearData: () =>
        set({
          data: null,
          timestamp: null,
        }),

      isExpired: () => {
        const { timestamp } = get();
        return timestamp ? Date.now() - timestamp > 5 * 60 * 1000 : true;
      },

      getData: () => {
        const { data, timestamp } = get();
        if (!data || !timestamp) return null;

        if (Date.now() - timestamp > 5 * 60 * 1000) {
          get().clearData();
          return null;
        }

        return data;
      },
    }),
    {
      name: "store-name",
    },
  ),
);
```
````

### **2. Utilisation**

```typescript
// Stockage
useStore.getState().setData(result.data);

// Lecture
const data = useStore.getState().getData();
if (data) {
  // Utiliser les donn√©es
  setData(data);
  useStore.getState().clearData();
}
```

## ‚úÖ Avantages

- ‚úÖ **Persistance au refresh** ‚Üí Avec devtools
- ‚úÖ **Type safety** ‚Üí TypeScript int√©gr√©
- ‚úÖ **Pattern familier** ‚Üí Coh√©rence avec le projet
- ‚úÖ **Debugging** ‚Üí Redux DevTools
- ‚úÖ **Performance** ‚Üí Pas de re-renders inutiles
- ‚úÖ **Expiration automatique** ‚Üí Gestion temporelle

````

### **√âtape 9 : Mettre √† Jour la Documentation Booking Security**

**Fichier :** `Documentation/GUIDES-TECHNIQUES/BOOKING-SECURITY-SYSTEM.md`

**Action :** ‚úÖ **D√âJ√Ä FAIT** - La documentation a √©t√© mise √† jour avec le nouveau syst√®me Zustand

---

## üõ°Ô∏è S√âCURIT√â ET AVANTAGES

### **‚úÖ Avantages de l'Approche Zustand**

1. **S√©curit√© Renforc√©e**
   - ‚ùå Pas d'acc√®s public aux donn√©es via API
   - ‚úÖ Donn√©es temporaires en m√©moire seulement
   - ‚úÖ Expiration automatique (5 minutes)

2. **Performance Am√©lior√©e**
   - ‚ùå Plus de requ√™tes base pour l'affichage
   - ‚úÖ Donn√©es en m√©moire locale
   - ‚úÖ Navigation plus rapide

3. **Simplicit√©**
   - ‚ùå Plus de gestion de tokens
   - ‚úÖ Pattern Zustand familier
   - ‚úÖ Moins de code √† maintenir

4. **Coh√©rence**
   - ‚úÖ Utilise le m√™me pattern que le reste de l'app
   - ‚úÖ Respecte les patterns de navigation
   - ‚úÖ Int√©gration avec devtools

### **üîí Politique RLS Simplifi√©e**

```sql
-- Seulement la policy INSERT publique (d√©j√† existante)
CREATE POLICY "bookings_insert_anon" ON "public"."bookings"
FOR INSERT TO anon
WITH CHECK (true);

-- Pas de policy SELECT publique (s√©curit√© maximale)
-- Les admins utilisent les policies existantes pour authenticated
````

---

## üß™ TESTS ET VALIDATION

### **Tests √† Effectuer**

1. **Test sur Domaine Principal**

   - ‚úÖ Cr√©ation de r√©servation
   - ‚úÖ Redirection vers success
   - ‚úÖ Affichage des donn√©es
   - ‚úÖ Nettoyage automatique

2. **Test sur Domaine Personnalis√©**

   - ‚úÖ Cr√©ation de r√©servation
   - ‚úÖ Redirection sans probl√®mes middleware
   - ‚úÖ Affichage des donn√©es
   - ‚úÖ Nettoyage automatique

3. **Test d'Expiration**

   - ‚úÖ Attendre 5 minutes
   - ‚úÖ V√©rifier redirection automatique
   - ‚úÖ V√©rifier nettoyage du store

4. **Test de Refresh**
   - ‚úÖ Refresh de la page success
   - ‚úÖ V√©rifier persistance des donn√©es
   - ‚úÖ V√©rifier expiration correcte

---

## üìã CHECKLIST D'IMPL√âMENTATION

### **Phase 1 : Store et API**

- [ ] Cr√©er `booking-confirmation-store.ts`
- [ ] Modifier API route `/api/booking/create`
- [ ] Modifier fonction `createBooking`
- [ ] Tester cr√©ation de r√©servation

### **Phase 2 : Pages**

- [ ] Modifier page confirmation
- [ ] Modifier page success
- [ ] Tester navigation compl√®te

### **Phase 3 : Nettoyage**

- [ ] Supprimer `getBookingWithToken`
- [ ] Supprimer scripts RLS obsol√®tes
- [ ] Supprimer policy SELECT publique
- [ ] V√©rifier RLS final

### **Phase 4 : Documentation**

- [ ] Cr√©er `ZUSTAND-PATTERN.md`
- [ ] V√©rifier `BOOKING-SECURITY-SYSTEM.md`
- [ ] Tester sur tous les domaines

---

## üéØ R√âSULTAT ATTENDU

**Probl√®me R√©solu :**

- ‚úÖ Redirection vers success fonctionne sur tous les domaines
- ‚úÖ Pas de probl√®mes de middleware
- ‚úÖ Navigation fluide sans param√®tres d'URL
- ‚úÖ S√©curit√© renforc√©e sans acc√®s public aux donn√©es
- ‚úÖ Performance am√©lior√©e (pas de requ√™tes base)
- ‚úÖ Code plus simple et maintenable

**Pattern √âtabli :**

- ‚úÖ Zustand pour donn√©es temporaires
- ‚úÖ Expiration automatique
- ‚úÖ Navigation s√©curis√©e
- ‚úÖ Documentation compl√®te
